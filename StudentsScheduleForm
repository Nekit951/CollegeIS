using System;
using System.Data;
using System.Drawing;
using System.Windows.Forms;
using System.IO;

namespace CollegeIS
{
    public partial class StudentsScheduleForm : Form
    {
        private string groupName;
        private DataTable scheduleData;
        private DataGridView dataGridView;
        private TextBox searchBox;
        private DateTimePicker dateFilter;
        private Button btnExport;
        private Button btnClose;
        private Label titleLabel;
        private Button btnResetFilters;
        private Label statusLabel;

        public StudentsScheduleForm(string groupName, DataTable scheduleData)
        {
            if (string.IsNullOrEmpty(groupName))
                throw new ArgumentException("Название группы не может быть пустым");

            if (scheduleData == null)
                throw new ArgumentNullException(nameof(scheduleData));

            this.groupName = groupName;
            this.scheduleData = scheduleData;

            InitializeForm();
        }

        private void InitializeForm()
        {
            // Базовая настройка формы
            this.Text = $"Расписание: {groupName}";
            this.Size = new Size(1000, 600);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.BackColor = Color.FromArgb(240, 245, 249);
            this.MinimumSize = new Size(800, 500);
            this.Padding = new Padding(10);

            CreateControls();
            SetupLayout();
        }

        private void CreateControls()
        {
            // Заголовок
            titleLabel = new Label
            {
                Text = $"Расписание занятий: {groupName}",
                Font = new Font("Segoe UI", 16F, FontStyle.Bold),
                ForeColor = Color.FromArgb(51, 51, 51),
                AutoSize = true
            };

            // Поле поиска
            searchBox = new TextBox
            {
                Text = "Поиск по дисциплине или преподавателю...",
                Size = new Size(250, 25),
                Font = new Font("Segoe UI", 9F),
                BackColor = Color.White,
                ForeColor = Color.Gray
            };

            searchBox.Enter += (s, e) =>
            {
                if (searchBox.Text == "Поиск по дисциплине или преподавателю...")
                {
                    searchBox.Text = "";
                    searchBox.ForeColor = Color.FromArgb(51, 51, 51);
                }
            };

            searchBox.Leave += (s, e) =>
            {
                if (string.IsNullOrEmpty(searchBox.Text))
                {
                    searchBox.Text = "Поиск по дисциплине или преподавателю...";
                    searchBox.ForeColor = Color.Gray;
                }
            };

            searchBox.TextChanged += (s, e) => ApplyFilters();

            // Фильтр по дате
            dateFilter = new DateTimePicker
            {
                Size = new Size(120, 25),
                Font = new Font("Segoe UI", 9F),
                Format = DateTimePickerFormat.Short
            };
            dateFilter.ValueChanged += (s, e) => ApplyFilters();

            // Кнопка сброса фильтров
            btnResetFilters = new Button
            {
                Text = "Сбросить",
                Size = new Size(80, 25),
                BackColor = Color.FromArgb(220, 220, 220),
                ForeColor = Color.FromArgb(51, 51, 51),
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9F),
                Cursor = Cursors.Hand
            };
            btnResetFilters.Click += (s, e) =>
            {
                searchBox.Text = "Поиск по дисциплине или преподавателю...";
                searchBox.ForeColor = Color.Gray;
                dateFilter.Value = DateTime.Now;
                ApplyFilters();
            };

            // DataGridView
            dataGridView = new DataGridView
            {
                BackgroundColor = Color.White,
                BorderStyle = BorderStyle.None,
                ReadOnly = true,
                AllowUserToAddRows = false,
                AllowUserToDeleteRows = false,
                AllowUserToResizeRows = false,
                RowHeadersVisible = false,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                Font = new Font("Segoe UI", 9F),
                AlternatingRowsDefaultCellStyle = new DataGridViewCellStyle
                {
                    BackColor = Color.FromArgb(250, 250, 250)
                },
                DefaultCellStyle = new DataGridViewCellStyle
                {
                    Padding = new Padding(5),
                    Alignment = DataGridViewContentAlignment.MiddleLeft
                },
                ColumnHeadersDefaultCellStyle = new DataGridViewCellStyle
                {
                    BackColor = Color.FromArgb(70, 130, 180), // Единый синий цвет для заголовков
                    ForeColor = Color.White,
                    Font = new Font("Segoe UI", 9F, FontStyle.Bold)
                }
            };

            // Настраиваем столбцы
            dataGridView.Columns.Add("Discipline", "Дисциплина");
            dataGridView.Columns.Add("LessonType", "Тип занятия");
            dataGridView.Columns.Add("Teacher", "Преподаватель");
            dataGridView.Columns.Add("Classroom", "Кабинет");
            dataGridView.Columns.Add("Date", "Дата");
            dataGridView.Columns.Add("Time", "Время");
            dataGridView.Columns.Add("DayOfWeek", "День недели");

            // Заполняем данными
            if (scheduleData.Rows.Count > 0)
            {
                foreach (DataRow row in scheduleData.Rows)
                {
                    if (row["Время"] != DBNull.Value && DateTime.TryParse(row["Время"].ToString(), out DateTime lessonTime))
                    {
                        dataGridView.Rows.Add(
                            row["Дисциплина"]?.ToString() ?? "",
                            row["ТипЗанятия"]?.ToString() ?? "",
                            row["Преподаватель"]?.ToString() ?? "",
                            row["Кабинет"]?.ToString() ?? "",
                            lessonTime.ToString("dd.MM.yyyy"),
                            lessonTime.ToString("HH:mm"),
                            GetRussianDayOfWeek(lessonTime)
                        );
                    }
                }
            }

            // Статус
            statusLabel = new Label
            {
                Font = new Font("Segoe UI", 9F),
                ForeColor = Color.FromArgb(100, 100, 100),
                AutoSize = true,
                Text = $"Всего занятий: {scheduleData.Rows.Count}"
            };

            // Кнопка экспорта
            btnExport = new Button
            {
                Text = "Экспорт CSV",
                Size = new Size(100, 30),
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9F),
                Cursor = Cursors.Hand
            };
            btnExport.Click += ExportToCsv;

            // Кнопка закрытия
            btnClose = new Button
            {
                Text = "Закрыть",
                Size = new Size(80, 30),
                BackColor = Color.FromArgb(231, 76, 60),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9F),
                Cursor = Cursors.Hand
            };
            btnClose.Click += (s, e) => this.Close();
        }

        private void SetupLayout()
        {
            // Используем TableLayout для надежного размещения
            TableLayoutPanel mainLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 1,
                RowCount = 4,
                Padding = new Padding(0),
                Margin = new Padding(0)
            };

            mainLayout.RowStyles.Add(new RowStyle(SizeType.AutoSize));
            mainLayout.RowStyles.Add(new RowStyle(SizeType.AutoSize));
            mainLayout.RowStyles.Add(new RowStyle(SizeType.Percent, 100F));
            mainLayout.RowStyles.Add(new RowStyle(SizeType.AutoSize));

            // Панель заголовка
            Panel headerPanel = new Panel
            {
                Height = 40,
                Dock = DockStyle.Fill,
                BackColor = Color.Transparent
            };
            headerPanel.Controls.Add(titleLabel);
            titleLabel.Location = new Point(0, 10);

            // Панель фильтров
            Panel filterPanel = new Panel
            {
                Height = 40,
                Dock = DockStyle.Fill,
                BackColor = Color.Transparent
            };

            searchBox.Location = new Point(0, 8);
            dateFilter.Location = new Point(searchBox.Right + 10, 8);
            btnResetFilters.Location = new Point(dateFilter.Right + 10, 8);

            filterPanel.Controls.AddRange(new Control[] { searchBox, dateFilter, btnResetFilters });

            // DataGridView
            dataGridView.Dock = DockStyle.Fill;

            // Панель статуса и кнопок
            Panel footerPanel = new Panel
            {
                Height = 40,
                Dock = DockStyle.Fill,
                BackColor = Color.Transparent
            };

            statusLabel.Location = new Point(0, 12);
            btnExport.Location = new Point(footerPanel.Width - 180, 5);
            btnClose.Location = new Point(footerPanel.Width - 90, 5);

            footerPanel.Controls.AddRange(new Control[] { statusLabel, btnExport, btnClose });

            // Добавляем все на главную панель
            mainLayout.Controls.Add(headerPanel, 0, 0);
            mainLayout.Controls.Add(filterPanel, 0, 1);
            mainLayout.Controls.Add(dataGridView, 0, 2);
            mainLayout.Controls.Add(footerPanel, 0, 3);

            this.Controls.Add(mainLayout);
        }

        private void ApplyFilters()
        {
            string searchText = searchBox.Text.ToLower();
            DateTime selectedDate = dateFilter.Value;

            int visibleCount = 0;

            foreach (DataGridViewRow row in dataGridView.Rows)
            {
                if (row.IsNewRow) continue;

                bool visible = true;

                // Фильтр по поиску
                if (!string.IsNullOrEmpty(searchText) && searchText != "поиск по дисциплине или преподавателю...")
                {
                    visible = (row.Cells["Discipline"].Value?.ToString().ToLower().Contains(searchText) == true) ||
                              (row.Cells["Teacher"].Value?.ToString().ToLower().Contains(searchText) == true) ||
                              (row.Cells["LessonType"].Value?.ToString().ToLower().Contains(searchText) == true);
                }

                // Фильтр по дате
                if (visible && row.Cells["Date"].Value != null)
                {
                    if (DateTime.TryParse(row.Cells["Date"].Value.ToString(), out DateTime rowDate))
                    {
                        visible = rowDate.Date == selectedDate.Date;
                    }
                }

                row.Visible = visible;
                if (visible) visibleCount++;
            }

            statusLabel.Text = $"Показано: {visibleCount} из {scheduleData.Rows.Count}";
        }

        private void ExportToCsv(object sender, EventArgs e)
        {
            try
            {
                using (SaveFileDialog saveDialog = new SaveFileDialog())
                {
                    saveDialog.Filter = "CSV files (*.csv)|*.csv";
                    saveDialog.FileName = $"Расписание_{groupName}_{DateTime.Now:yyyyMMdd}.csv";

                    if (saveDialog.ShowDialog() == DialogResult.OK)
                    {
                        using (StreamWriter writer = new StreamWriter(saveDialog.FileName, false, System.Text.Encoding.UTF8))
                        {
                            writer.WriteLine("Дисциплина;Тип занятия;Преподаватель;Кабинет;Дата;Время;День недели");

                            foreach (DataGridViewRow row in dataGridView.Rows)
                            {
                                if (!row.IsNewRow && row.Visible)
                                {
                                    writer.WriteLine(
                                        $"{EscapeCsv(row.Cells["Discipline"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["LessonType"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["Teacher"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["Classroom"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["Date"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["Time"].Value?.ToString())};" +
                                        $"{EscapeCsv(row.Cells["DayOfWeek"].Value?.ToString())}"
                                    );
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                // Тихая обработка ошибок
                Console.WriteLine($"Ошибка экспорта: {ex.Message}");
            }
        }

        private string EscapeCsv(string value)
        {
            if (string.IsNullOrEmpty(value)) return "";
            if (value.Contains(";") || value.Contains("\"") || value.Contains("\n"))
            {
                return $"\"{value.Replace("\"", "\"\"")}\"";
            }
            return value;
        }

        private string GetRussianDayOfWeek(DateTime date)
        {
            switch (date.DayOfWeek)
            {
                case DayOfWeek.Monday: return "Пн";
                case DayOfWeek.Tuesday: return "Вт";
                case DayOfWeek.Wednesday: return "Ср";
                case DayOfWeek.Thursday: return "Чт";
                case DayOfWeek.Friday: return "Пт";
                case DayOfWeek.Saturday: return "Сб";
                case DayOfWeek.Sunday: return "Вс";
                default: return "";
            }
        }
    }
}
